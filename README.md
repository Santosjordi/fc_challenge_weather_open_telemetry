# Fullcycle Lab - Observabilidade & Open Telemetry

## Weather Orchestration Service

This project provides two Go microservices (`service-a-input` and `service-b-orchestration`) connected with **OpenTelemetry** and **Zipkin** for distributed tracing.

* **Service A**: Public-facing entrypoint, receives ZIP codes and calls Service B.
* **Service B**: Orchestration service, retrieves weather data.

The services communicate via HTTP, and telemetry is exported to the **OpenTelemetry Collector**, which forwards spans to **Zipkin**.

---

## Requirements

* [Docker](https://docs.docker.com/get-docker/)
* [Docker Compose](https://docs.docker.com/compose/)

---

## Environment Variables

| Variable                      | Description                                        | Required |
| ----------------------------- | -------------------------------------------------- | -------- |
| `WEATHER_API_KEY`             | API key for the external weather API               | ✅ Yes    |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | Optional, defaults to `http://otel-collector:4318` | No       |

> **Note:** This is the **only environment variable you must set** (`WEATHER_API_KEY`). All ports, service URLs, and telemetry configuration are pre-configured in `docker-compose.yml`.

---

## Running the project

1. Copy `.env.example` to `.env` and add your weather API key:

```bash
cp .env.example .env
echo "WEATHER_API_KEY=your_api_key_here" >> .env
```

2. Start the stack:

```bash
docker compose up --build
```

3. Access the services:

* **Service A** → [http://localhost:8080](http://localhost:8080)
* **Zipkin UI** → [http://localhost:9411](http://localhost:9411)

---

## Using Zipkin

The project includes a **Zipkin container** for distributed tracing. Here’s how to use it:

### 1. Open the Zipkin UI

Go to:

```
http://localhost:9411
```

This is where all traces sent by your services will appear.

### 2. Generate traces

Send a request to Service A:

```bash
curl -X POST http://localhost:8080/zipcode \
  -H "Content-Type: application/json" \
  -d '{"cep": "01001000"}'
```

* Service A will call Service B.
* Service B will call **ViaCEP** and **WeatherAPI**.
* Each step generates **spans** that appear in Zipkin.

### 3. Search and view traces

* In Zipkin, search by **service name** (`service-a-input` or `service-b-orchestration`).
* Click a trace to see the **timeline**, **parent-child relationships**, and **attributes** like validation status or error messages.

### 4. Common troubleshooting

* Make sure `OTEL_EXPORTER_OTLP_ENDPOINT` points to `http://otel-collector:4318` if you are using HTTP.
* Ensure spans are actually generated by sending requests to Service A.
* Give it a few seconds — traces are sent asynchronously.

---

## Quick Test Example

```bash
curl -X POST http://localhost:8080/zipcode \
  -H "Content-Type: application/json" \
  -d '{"cep":"01001000"}'
```

* Check Zipkin to see the trace for this request.
* You should see spans for:

```
service-a-input
 └─ call-service-b
     ├─ call-viacep-api
     └─ call-weather-api
```

---

## Notes

* Service B is **internal**; users should interact only with Service A.
* Default ports: Service A → 8080, Service B → 8081, Zipkin → 9411.
* Tracing is fully enabled by default via OpenTelemetry Collector.

---
